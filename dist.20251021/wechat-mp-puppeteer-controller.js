(()=>{var e={758:e=>{"use strict";e.exports=require("puppeteer")},785:e=>{"use strict";e.exports=require("readline")},857:e=>{"use strict";e.exports=require("os")},878:(e,t,a)=>{const n=a(896),o=a(928),c=o.join(__dirname,"accounts-data.json");t.initAccountManager=()=>{n.existsSync(c)||n.writeFileSync(c,JSON.stringify([]),"utf8")},t.getAllAccounts=()=>{try{const e=n.readFileSync(c,"utf8");return JSON.parse(e)}catch(e){return console.error(`读取账号数据失败: ${e.message}`),[]}},t.getAccountById=e=>t.getAllAccounts().find(t=>t.id===e)||null,t.addAccount=e=>{try{const a=t.getAllAccounts();return e.id=e.id||`account_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,e.lastLogin=(new Date).toISOString(),a.push(e),n.writeFileSync(c,JSON.stringify(a,null,2),"utf8"),!0}catch(e){return console.error(`添加账号失败: ${e.message}`),!1}},t.updateAccount=(e,a)=>{try{const o=t.getAllAccounts(),s=o.findIndex(t=>t.id===e);return-1!==s&&(o[s]={...o[s],...a},n.writeFileSync(c,JSON.stringify(o,null,2),"utf8"),!0)}catch(e){return console.error(`更新账号信息失败: ${e.message}`),!1}},t.updateAccountLastLogin=e=>t.updateAccount(e,{lastLogin:(new Date).toISOString()}),t.deleteAccount=e=>{try{const a=t.getAllAccounts(),o=a.filter(t=>t.id!==e);return a.length!==o.length&&(n.writeFileSync(c,JSON.stringify(o,null,2),"utf8"),!0)}catch(e){return console.error(`删除账号失败: ${e.message}`),!1}},t.createUserDataDir=e=>{const t=o.join(__dirname,"user-data"),a=o.join(t,e);return n.existsSync(a)||n.mkdirSync(a,{recursive:!0}),a},t.getAccountInfoFromPage=async e=>{try{return await e.evaluate(()=>{let e="未知公众号",t="unknown",a="";const n=document.querySelectorAll(".weui-desktop-person_info .weui-desktop_name, .account_box-body .acount_box-nickname");if(n.length>0)for(const t of n)if(t.textContent&&t.textContent.trim()){e=t.textContent.trim();break}try{t=wx.data.user_name}catch(e){console.error(`获取微信ID失败: ${e.message}`)}const o=document.querySelectorAll(".weui-desktop-person_info .weui-desktop-account__img, .account_box-body .weui-desktop-account__thumb");if(o.length>0)for(const e of o){const t=e.src||"";if(t&&t.includes("http")&&!t.includes("default_avatar")&&!t.includes("placeholder")){a=t;break}}return{name:e,wechatId:t,avatar:a}})}catch(e){return console.error(`从页面获取账号信息失败: ${e.message}`),{name:"未知公众号",wechatId:"unknown",avatar:""}}},t.initAccountManager()},896:e=>{"use strict";e.exports=require("fs")},928:e=>{"use strict";e.exports=require("path")}},t={};function a(n){var o=t[n];if(void 0!==o)return o.exports;var c=t[n]={exports:{}};return e[n](c,c.exports,a),c.exports}const n=a(928),o=a(785),c=a(758),s=a(896),r=a(857),i=a(878),l={headless:!1,delayBetweenActions:3e3,maxRetries:3,timeout:6e4,logFile:n.join(__dirname,"wechat-mp-auto-controller.log"),userDataDir:n.join(__dirname,"user-data")},u=()=>{const e=r.platform();return"darwin"===e?"/Applications/Google Chrome.app/Contents/MacOS/Google Chrome":"win32"===e?"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe":"linux"===e?"/usr/bin/google-chrome":""};let d="",g=null,w=new Map;const m=e=>{const t=`[${(new Date).toISOString()}] ${e}`;console.log(t),(e=>{const t=`[${(new Date).toISOString()}] ${e}\n`;try{s.appendFileSync(l.logFile,t,"utf8")}catch(e){console.error(`无法写入日志文件: ${e.message}`)}})(e)},y=e=>new Promise(t=>setTimeout(t,e)),p=async e=>{m("请在浏览器中扫码登录微信公众号...");try{m("等待页面跳转以获取登录状态..."),await e.waitForNavigation({waitUntil:"networkidle0",timeout:12e4});const t=e.url().match(/token=([^&]+)/);if(t&&t[1])return d=t[1],m(`成功获取token: ${d}`),m("登录成功！"),!0}catch(e){m(`等待页面跳转超时: ${e.message}`)}m("检查页面内容以确定登录状态...");let t=!1;try{if(e.isClosed())return m("警告：页面已关闭，无法检查登录状态"),!1;t=await e.evaluate(()=>{if(!document||!document.body)return!1;const e=document.body.textContent.toLowerCase();return["首页","素材管理","内容创作","已登录","我的账号"].some(t=>e.includes(t.toLowerCase()))})}catch(t){if(m(`检查登录状态时出错: ${t.message}`),t.message&&t.message.includes("detached Frame")){m("检测到Frame已分离，尝试通过URL检查登录状态...");const t=e.url();if(t.includes("token=")){const e=t.match(/token=([^&]+)/);return e&&e[1]&&(d=e[1],m(`成功获取token: ${d}`)),m("登录成功！"),!0}}return!1}if(t){const t=e.url().match(/token=([^&]+)/);return t&&t[1]&&(d=t[1],m(`成功获取token: ${d}`)),m("登录成功！"),!0}return m("警告：未能确认登录状态。如果您已经登录，请刷新页面并重试。"),!1},h=async e=>{await x(e),e.on("framenavigated",async()=>{m("检测到页面框架导航事件"),await x(e)}),e.on("load",async()=>{m("检测到页面加载完成事件"),await x(e)}),e.on("domcontentloaded",async()=>{m("检测到DOM内容加载完成事件"),await y(500),await x(e)})},f=async(e,t)=>{m("开始监测页面URL变化和新标签页创建..."),await h(e),t.on("targetcreated",async e=>{try{if("page"===e.type()){m("检测到新标签页创建");const t=await e.page();t&&(await t.waitForNavigation({waitUntil:"domcontentloaded",timeout:5e3}).catch(()=>{m("新标签页导航等待超时，继续执行")}),m("为新标签页设置事件监听器"),await h(t))}}catch(e){m(`处理新标签页时出错: ${e.message}`)}}),await new Promise(e=>{const t=o.createInterface({input:process.stdin,output:process.stdout});m("按Enter键退出程序..."),t.on("line",()=>{m("程序退出中..."),t.close(),g.close().then(e)})})},x=async e=>{const t=e.url();m(`当前页面URL: ${t}`),await e.evaluate(()=>{window.lastCheckedTime=Date.now()}),t.includes("cgi-bin/appmsg")&&t.includes("action=list_video")?(m("检测到视频素材管理页，准备执行视频批量上传功能..."),await v(e)):t.includes("cgi-bin/user_tag")&&t.includes("action=get_all_data")?(m("检测到用户管理页，准备执行用户批量打标签功能..."),await b(e)):t.includes("cgi-bin/appmsg")&&t.includes("t=media/appmsg_edit_v2")&&t.includes("action=edit")?(m("检测到视频配置页面，准备执行自动配置功能..."),await $(e)):t.includes("mp.weixin.qq.com")&&t.includes("cgi-bin/login")?m("当前为登录页，请登录后继续"):t.includes("videomsg_edit")?m("当前为素材管理编辑页"):(m("当前为其他页面，清除注入标记"),await e.evaluate(()=>{window.chromeDebugUploaderInjected=!1,window.chromeDebugTagInjected=!1,window.chromeDebugConfigAutoInjected=!1}))},$=async e=>{const t=`config-${Date.now()}-${Math.floor(1e3*Math.random())}`;m(`准备注入视频配置自动脚本 - 页面ID: ${t}`);try{const a=e.url();if(!a.includes("cgi-bin/appmsg")||!a.includes("t=media/appmsg_edit_v2")||!a.includes("action=edit"))return void m(`跳过注入 - 非视频配置页面: ${a}`);await e.evaluate(()=>window.chromeDebugConfigAutoInjected||!1)&&m("视频配置自动操作脚本在其他页面已经注入过"),m("准备注入视频配置自动操作脚本...");const o=n.join(__dirname,"chrome-debug-config-auto.js");if(!s.existsSync(o))throw new Error(`找不到视频配置自动操作脚本文件: ${o}`);const c=s.readFileSync(o,"utf8");await e.evaluate(e=>{window._configPageInstanceId=e},t),await e.evaluate(e=>{const t=document.createElement("script");t.textContent=e,document.head.appendChild(t),window.chromeDebugConfigAutoInjected=!0},c),m("视频配置自动操作脚本注入成功！"),m("脚本将自动执行以下操作："),m("1. 点击留言配置按钮并确认"),m('2. 点击声明按钮，选择"内容来自AI"，点击确认'),m("3. 点击保存按钮完成配置"),async function(e,t){try{const a=6e4,n=1e3;let o=0;for(m(`开始监控配置完成状态 - 页面ID: ${t}`);o<a;){await new Promise(e=>setTimeout(e,n)),o+=n;try{if(await e.evaluate(()=>!0===window._configAutoCompleted))return m(`检测到配置已完成，等待2秒后安全关闭页面 - 页面ID: ${t}`),await new Promise(e=>setTimeout(e,2e3)),await e.close({waitUntil:"networkidle0",timeout:1e4}),void m(`页面已安全关闭 - 页面ID: ${t}`)}catch(e){return void m(`监控过程中遇到错误，可能页面已关闭 - 页面ID: ${t}`)}}m(`监控超时，页面未完成配置 - 页面ID: ${t}`)}catch(e){m(`监控配置完成状态时出错: ${e.message}`)}}(e,t)}catch(e){m(`注入视频配置自动操作脚本失败: ${e.message}`),e.stack&&console.error(e.stack)}};const v=async e=>{try{const t=e.url();if(!t.includes("cgi-bin/appmsg")||!t.includes("action=list_video"))return void m("警告：当前页面不适合注入视频上传脚本，跳过注入");m("准备注入视频上传脚本...");const a=n.join(__dirname,"chrome-debug-uploader.js");if(!s.existsSync(a))throw new Error(`找不到视频上传脚本文件: ${a}`);const o=s.readFileSync(a,"utf8");await e.evaluate(e=>{const t=document.createElement("script");t.textContent=e,document.head.appendChild(t)},o),m("视频上传脚本注入成功！")}catch(e){m(`注入视频上传脚本失败: ${e.message}`)}},b=async e=>{try{const t=e.url();if(!t.includes("cgi-bin/user_tag")||!t.includes("action=get_all_data"))return void m("警告：当前页面不适合注入用户标签脚本，跳过注入");m("准备注入用户标签脚本...");const a=n.join(__dirname,"chrome-debug-tag.js");if(!s.existsSync(a))throw new Error(`找不到用户标签脚本文件: ${a}`);const o=s.readFileSync(a,"utf8");await e.evaluate(e=>{const t=document.createElement("script");t.textContent=e,document.head.appendChild(t)},o),m("批量打标签按钮脚本已注入，请点击按钮开始操作")}catch(e){m(`注入用户标签脚本失败: ${e.message}`)}},_=async(e,t,a=l.maxRetries)=>{var n;let o=null;for(let n=1;n<=a;n++)try{m(`尝试执行${t} (第${n}/${a}次尝试)`);const o=await e();return m(`${t}执行成功`),o}catch(e){o=e,m(`尝试${n}执行${t}失败: ${e.message}`),n<a&&(m(`等待${l.delayBetweenActions}毫秒后重试...`),await y(l.delayBetweenActions))}throw new Error(`${t}在${a}次尝试后仍然失败: ${(null===(n=o)||void 0===n?void 0:n.message)||"未知错误"}`)};const S=async(e,t)=>{switch(e){case"manage":m("微信公众号自动控制器启动 - 账号管理模式"),await(async()=>{m("启动账号管理页面...");try{const e=u();g&&g.isConnected()||(g=await c.launch({headless:!1,defaultViewport:null,args:["--start-maximized"],executablePath:e||void 0,timeout:l.timeout,slowMo:100}),g.on("disconnected",()=>{m("浏览器已关闭"),g=null,w.clear()}));const t=await g.newPage(),a=n.join(__dirname,"account-manager.html"),o=s.readFileSync(a,"utf8"),r=i.getAllAccounts(),d=n.join(__dirname,"temp-account-manager.html");s.writeFileSync(d,o,"utf8");const y=t;await y.evaluate(e=>{window.__ACCOUNTS__=e},r),global.accountManagerPage=y,await t.exposeFunction("addNewAccount",async()=>{try{if(await A(),y&&!y.isClosed())try{await y.evaluate(()=>{"function"==typeof window.refreshAccountsList&&window.refreshAccountsList()})}catch(e){m(`刷新账号列表时出错: ${e.message}`)}}catch(e){m(`添加账号过程中出错: ${e.message}`),console.error(e)}}),await t.exposeFunction("switchToAccount",async e=>{try{await S("switch-account",e)}catch(e){m(`切换账号过程中出错: ${e.message}`),console.error(e)}}),await t.exposeFunction("deleteAccount",async e=>{try{if(m(`前端触发删除账号: ${e}`),console.log(`后端接收到删除账号请求，账号ID: ${e}`),!e||"string"!=typeof e)throw new Error(`无效的账号ID: ${e}`);if(console.log(`当前活跃账号数量: ${w.size}`),console.log("准备调用handleAction删除账号"),await S("delete-account",e),console.log("handleAction删除账号完成"),console.log("准备刷新账号列表"),global.accountManagerPage&&!global.accountManagerPage.isClosed()){console.log("账号管理页面有效，尝试刷新列表");try{const e=i.getAllAccounts();await global.accountManagerPage.evaluate(e=>{window.__ACCOUNTS__=e,console.log("重新注入账号数据:",e)},e),await global.accountManagerPage.evaluate(()=>{console.log("执行前端refreshAccountsList函数"),"function"==typeof window.refreshAccountsList?window.refreshAccountsList():console.error("window.refreshAccountsList函数不存在")}),console.log("账号列表刷新完成")}catch(e){m(`刷新账号列表时出错: ${e.message}`),console.error("刷新账号列表错误:",e)}}else console.log("账号管理页面已关闭或无效，无法刷新列表")}catch(e){throw m(`删除账号过程中出错: ${e.message}`),console.error("删除账号错误:",e),e}}),await t.exposeFunction("getLatestAccounts",async()=>{try{m("前端请求获取最新账号数据");const e=i.getAllAccounts();return m(`成功获取最新账号数据，共${e.length}个账号`),e}catch(e){return m(`获取最新账号数据失败: ${e.message}`),console.error("获取最新账号数据错误:",e),[]}}),await t.goto(`file://${d}`,{timeout:l.timeout}),await t.evaluate(e=>{window.__ACCOUNTS__=e,"function"==typeof window.refreshAccountsList&&window.refreshAccountsList()},r);const p=(e,t)=>new Promise(e=>{const a=Date.now(),n=setInterval(()=>{Date.now()-a>t&&(clearInterval(n),m("等待浏览器关闭超时"),e());try{g.targets().some(e=>"page"===e.type()&&"about:blank"!==e.url())||(clearInterval(n),e())}catch(t){clearInterval(n),e()}},1e3)});await p(g,36e5);try{s.unlinkSync(d)}catch(e){m(`警告：无法删除临时文件: ${e.message}`)}}catch(e){m(`启动账号管理页面失败: ${e.message}`),console.error(e)}})();break;case"add-account":m("微信公众号自动控制器启动 - 添加新账号模式"),await A();break;case"switch-account":if(!t)return void m("错误：切换账号时需要提供账号ID");m(`微信公众号自动控制器启动 - 切换到账号: ${t}`),await C(t);break;case"delete-account":if(!t)return void m("错误：删除账号时需要提供账号ID");m(`删除账号: ${t}`);if(i.deleteAccount(t)){if(m("账号删除成功"),w.has(t))try{const e=w.get(t);e&&e.page&&!e.page.isClosed()&&await e.page.close(),w.delete(t),m(`已关闭并移除账号 ${t} 的页面引用`)}catch(e){m(`清理账号页面引用时出错: ${e.message}`)}}else m("账号删除失败");await y(2e3);break;default:m(`未知操作: ${e}`),m("可用操作: manage, add-account, switch-account, delete-account")}},A=async()=>{try{const e=u();e||m("警告：未能自动检测到系统Chrome路径，请确保Chrome已安装");const t=`account_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,a=i.createUserDataDir(t);m(`为新账号创建用户数据目录: ${a}`),m("创建新的浏览器实例用于新账号登录...");const n=await _(async()=>await c.launch({headless:l.headless,defaultViewport:null,args:["--start-maximized",`--user-data-dir=${a}`],executablePath:e||void 0}),"启动浏览器实例"),o=await n.newPage();await o.goto("https://mp.weixin.qq.com/"),await y(2e3),m("请在新打开的浏览器窗口中扫码登录...");if(!await p(o))return m("登录失败或未检测到登录状态"),await y(5e3),void await n.close();m("登录成功，正在获取公众号信息...");const s=await i.getAccountInfoFromPage(o),r={id:t,name:s.name,wechatId:s.wechatId,avatar:s.avatar,userDataDir:a,lastLogin:(new Date).toISOString()};i.addAccount(r)?(m(`账号信息保存成功: ${s.name} (${s.wechatId})`),m(`账号数据目录: ${a}`)):m("账号信息保存失败"),w.set(t,{page:o,browser:n}),await _(async()=>{await o.evaluate(e=>{const t=document.createElement("div");t.id="auto-controller-panel",t.style.position="fixed",t.style.top="20px",t.style.left="20px",t.style.zIndex="9999",t.style.backgroundColor="white",t.style.border="1px solid #e7e7eb",t.style.borderRadius="8px",t.style.padding="15px",t.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.1)",t.style.maxWidth="350px",t.style.fontSize="14px",t.style.color="#333",t.style.fontFamily="-apple-system, BlinkMacSystemFont, sans-serif";const a=document.createElement("h4");a.textContent="微信公众号自动控制器",a.style.margin="0 0 15px 0",a.style.fontSize="16px",a.style.color="#1aad19";const n=document.createElement("div");n.id="status-info",n.textContent="状态：账号添加完成，登录信息已保存",n.style.marginBottom="15px",n.style.fontSize="13px",n.style.color="#666";const o=document.createElement("div");o.style.display="flex",o.style.gap="10px",o.style.flexWrap="wrap";const c=document.createElement("button");c.textContent="刷新页面",c.style.padding="6px 12px",c.style.backgroundColor="#07c160",c.style.color="white",c.style.border="none",c.style.borderRadius="4px",c.style.cursor="pointer",c.style.fontSize="12px",c.style.transition="background-color 0.3s",c.addEventListener("mouseover",()=>{c.style.backgroundColor="#06ad56"}),c.addEventListener("mouseout",()=>{c.style.backgroundColor="#07c160"}),c.addEventListener("click",()=>{location.reload()});const s=document.createElement("button");s.textContent="帮助",s.style.padding="6px 12px",s.style.backgroundColor="#1890ff",s.style.color="white",s.style.border="none",s.style.borderRadius="4px",s.style.cursor="pointer",s.style.fontSize="12px",s.style.transition="background-color 0.3s",s.addEventListener("mouseover",()=>{s.style.backgroundColor="#40a9ff"}),s.addEventListener("mouseout",()=>{s.style.backgroundColor="#1890ff"}),s.addEventListener("click",()=>{alert("使用说明：\n\n1. 账号添加完成后，登录状态已保存\n2. 您可以关闭当前窗口，稍后通过账号管理页面切换到此账号\n3. 下次切换到此账号时，无需重新登录\n\n注意：请确保Chrome浏览器版本与Puppeteer兼容")}),o.appendChild(c),o.appendChild(s),t.appendChild(a),t.appendChild(n),document.body.appendChild(t)},l.videoDirectory)},"创建操作面板"),m("账号添加完成，登录状态已保存"),m("您可以关闭当前窗口，稍后通过账号管理页面切换到此账号"),await f(o,n)}catch(e){m(`程序运行出错: ${e.message}`),console.error("错误详情:",e);const t=n.join(__dirname,"error.log");try{const a=`[${(new Date).toISOString()}] 错误: ${e.message}\n堆栈跟踪: ${e.stack}\n----------------------------------------\n`;s.appendFileSync(t,a,"utf8"),m(`详细错误信息已保存至: ${t}`)}catch(e){console.error("无法保存错误日志:",e.message)}}finally{m("微信公众号自动控制器程序结束"),console.log("============================================"),console.log("  程序已结束，感谢使用微信公众号自动控制器"),console.log("============================================")}},C=async e=>{try{const t=u();t||m("警告：未能自动检测到系统Chrome路径，请确保Chrome已安装");const a=i.getAccountById(e);if(!a)return void m(`错误：找不到账号ID为 ${e} 的账号信息`);if(!s.existsSync(a.userDataDir))return void m(`错误：账号的用户数据目录不存在: ${a.userDataDir}`);m(`加载账号: ${a.name} (${a.wechatId})`);const n=await _(async()=>await c.launch({headless:l.headless,defaultViewport:null,args:["--start-maximized",`--user-data-dir=${a.userDataDir}`],executablePath:t||void 0}),"启动浏览器");n.on("disconnected",()=>{m(`${a.name} 的浏览器已关闭`),w.delete(e)});const o=await n.newPage();w.set(e,{page:o,browser:n,userDataDir:a.userDataDir}),await o.goto("https://mp.weixin.qq.com/"),await y(2e3);const r=await(async e=>{try{return!!(await e.url()).includes("token=")||(await e.waitForSelector("body",{timeout:3e3}),await e.evaluate(()=>{const e=document.querySelector("div.login_code_img");return null!==document.querySelector("#main-container")&&null===e}))}catch(e){return m(`检查登录状态时出错: ${e.message}`),!1}})(o);if(!r){m("账号登录状态已失效，请重新登录");if(!await p(o))return m("重新登录失败，程序将在10秒后退出"),await y(1e4),void(n&&n.isConnected()&&await n.close());i.updateAccountLastLogin(e)}i.updateAccountLastLogin(e),m(`账号 ${a.name} 登录成功，开始监测页面URL变化...`),await _(async()=>{await o.evaluate((e,t)=>{const a=document.createElement("div");a.id="auto-controller-panel",a.style.position="fixed",a.style.top="20px",a.style.left="20px",a.style.zIndex="9999",a.style.backgroundColor="white",a.style.border="1px solid #e7e7eb",a.style.borderRadius="8px",a.style.padding="15px",a.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.1)",a.style.maxWidth="350px",a.style.fontSize="14px",a.style.color="#333",a.style.fontFamily="-apple-system, BlinkMacSystemFont, sans-serif";const n=document.createElement("h4");n.textContent="微信公众号增强功能已加载",n.style.margin="0 0 15px 0",n.style.fontSize="16px",n.style.color="#1aad19",a.appendChild(n),document.body.appendChild(a)},a)},"创建操作面板"),await f(o,n)}catch(e){m(`切换账号时出错: ${e.message}`),console.error("错误详情:",e);const t=n.join(__dirname,"error.log");try{const a=`[${(new Date).toISOString()}] 错误: ${e.message}\n堆栈跟踪: ${e.stack}\n----------------------------------------\n`;s.appendFileSync(t,a,"utf8"),m(`详细错误信息已保存至: ${t}`)}catch(e){console.error("无法保存错误日志:",e.message)}}};!async function(){try{const e=function(){const e=process.argv.slice(2),t={action:"manage",accountId:null};for(let a=0;a<e.length;a++)"--action"===e[a]&&a+1<e.length?(t.action=e[a+1],a++):"--accountId"===e[a]&&a+1<e.length&&(t.accountId=e[a+1],a++);return t}();if(process.argv.length>2&&process.argv[2].startsWith("?")){const t=new URLSearchParams(process.argv[2].substring(1)),a=t.get("action")||e.action,n=t.get("accountId")||e.accountId;await S(a,n)}else"manage"!==e.action?await S(e.action,e.accountId):await S("manage",null)}catch(e){m(`程序执行出错: ${e.message}`),console.error(e),await y(5e3)}}(),module.exports={}})();