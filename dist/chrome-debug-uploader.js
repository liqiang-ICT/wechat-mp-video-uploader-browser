(()=>{console.log("微信公众号视频上传调试工具(视频列表页版本)已加载");let e=null,t=null;function n(e){const t=document.getElementById("chrome-debug-info");t?(t.textContent=e,t.style.display="block",console.log("[调试信息]",e)):console.log("[调试信息]",e)}function o(e){const t=document.getElementById("chrome-debug-info");t?(t.textContent+="\n"+e,console.log("[调试信息]",e)):console.log("[调试信息]",e)}function i(e){return new Promise(t=>setTimeout(t,e))}function l(e,t=document){const n=t.querySelector(e);return console.log(`查找元素: ${e}, 结果: ${n?"找到":"未找到"}`),n}function s(e,t=document){for(const n of e){const e=l(n,t);if(e)return console.log(`使用选择器成功找到元素: ${n}`),e}return console.warn(`尝试了 ${e.length} 种选择器都未能找到元素`),null}function a(e,t="元素"){if(!e)return console.error(`${t}不存在，无法点击`),!1;try{return e.click(),console.log(`成功点击 ${t}`),!0}catch(e){return console.error(`点击 ${t} 时出错:`,e),!1}}function c(e,t){if(!e||!t)return null;const n=e.split("?")[1];if(!n)return null;const o=n.split("&");for(const e of o){const[n,o]=e.split("=");if(n===t)return o}return null}function r(e){const t=e.match(/^(.*)\((\d+)\)(\.[^.]+)?$/);if(t){const n=t[1].trim()+(t[3]||"");return console.log(`规范化文件名: ${e} -> ${n}`),n}return e}function d(e){const t=r(e.name);return t!==e.name?new File([e],t,{type:e.type,lastModified:e.lastModified}):e}async function p(){const i=document.querySelector("#pushFeaturedButton");i&&(i.disabled=!0,i.textContent=e?"加载缓存中...":"收集素材中...");const l=await async function(){if(e)return console.log("使用缓存的素材数据"),console.log("缓存中的素材数：",e.length),e;console.log("缓存不存在，重新收集素材");const n=await $(500);if(console.log("共发现文章数：",n.length),console.log("文章列表：",n),0===n.length)return console.log("未发现文章"),e=[],t=now,[];const o=[];for(const e of n)o.push({app_id:e.app_id,title:e.title,publish_time:e.publish_time,is_non_original:e.is_non_original});return e=o,t=Date.now(),console.log("素材已缓存，将一直有效直到页面刷新"),o}();if(0===l.length)return console.log("未发现素材"),void(i&&(i.textContent="推送精选",i.disabled=!1));i&&(i.textContent="推送精选",i.disabled=!1);let s="选择素材";!!e&&t&&(s=`选择素材 (使用缓存，缓存时间: ${new Date(t).toLocaleTimeString()})`),function(e,t,n,o){const i=document.createElement("div");i.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background-color: rgba(0, 0, 0, 0.5);\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        z-index: 9999;\n        font-family: Arial, sans-serif;\n    ";const l=document.createElement("div");l.style.cssText="\n        background-color: white;\n        border-radius: 8px;\n        padding: 20px;\n        width: 80%;\n        max-width: 600px;\n        max-height: 80vh;\n        display: flex;\n        flex-direction: column;\n    ";const s=document.createElement("h3");s.textContent=t||"选择素材",s.style.marginTop="0";const a=document.createElement("div");a.style.cssText="\n        flex: 1;\n        overflow-y: auto;\n        margin: 15px 0;\n        border: 1px solid #eee;\n        border-radius: 4px;\n        padding: 10px;\n    ";const c=document.createElement("div");c.style.cssText="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee;";const r=document.createElement("input");r.type="checkbox",r.id="selectAll";const d=document.createElement("label");d.htmlFor="selectAll",d.textContent="全选",d.style.marginLeft="8px",c.appendChild(r),c.appendChild(d),a.appendChild(c);const p=[];e.forEach((e,t)=>{const n=document.createElement("div");n.style.cssText="margin-bottom: 8px;";const o=document.createElement("input");o.type="checkbox",o.id=`item_${t}`,o.value=e.app_id,p.push(o);const i=document.createElement("label");i.htmlFor=`item_${t}`,i.textContent=`${e.title}${1===e.is_non_original?" (非原创)":""}`,i.style.marginLeft="8px",i.style.cursor="pointer",n.appendChild(o),n.appendChild(i),a.appendChild(n)});const u=document.createElement("div");u.style.cssText="display: flex; justify-content: flex-end; gap: 10px;";const m=document.createElement("button");m.textContent="取消",m.style.cssText="\n        padding: 8px 16px;\n        background-color: #f1f1f1;\n        border: none;\n        border-radius: 4px;\n        cursor: pointer;\n    ";const f=document.createElement("button");f.textContent="确定",f.style.cssText="\n        padding: 8px 16px;\n        background-color: #4CAF50;\n        color: white;\n        border: none;\n        border-radius: 4px;\n        cursor: pointer;\n    ",u.appendChild(m),u.appendChild(f),l.appendChild(s),l.appendChild(a),l.appendChild(u),i.appendChild(l),r.addEventListener("change",()=>{const e=r.checked;p.forEach(t=>{t.checked=e})}),m.addEventListener("click",()=>{document.body.removeChild(i),o&&o()}),f.addEventListener("click",()=>{const t=[];p.forEach((n,o)=>{n.checked&&t.push(e[o])}),document.body.removeChild(i),n&&n(t)}),i.addEventListener("click",e=>{e.target===i&&(document.body.removeChild(i),o&&o())}),document.body.appendChild(i)}(l,s,async e=>{if(0===e.length)return void n("未选择任何素材");i&&(i.textContent=`推送精选 (0/${e.length})`,i.disabled=!0),console.log(`选择了 ${e.length} 个素材进行推送`),n(`准备推送 ${e.length} 个素材...`);const t=c(window.location.href,"token");e.length>0?await async function l(s){if(s>=e.length)return i&&(i.textContent="推送精选",i.disabled=!1),void n(`推送精选完成，已为 ${e.length} 个素材打开推送链接`);i&&(i.textContent=`推送精选 (${s+1}/${e.length})`,i.disabled=!0);const a=e[s];try{const i=Date.now(),c=a.app_id,r=`https://mp.weixin.qq.com/cgi-bin/appmsg?t=media/appmsg_edit_v2&action=edit&isNew=1&type=10&material_type=15&material_id=${c}&token=${t}&lang=zh_CN&timestamp=${i}`;console.log(`为素材 ${a.title} (ID: ${c}) 打开推送链接`),n(`正在打开第 ${s+1}/${e.length} 个素材: ${a.title}`);const d=window.open(r,"_blank");await async function(e,t){return new Promise(n=>{const i=2e3,l=3e5,s=Date.now();let a=0;console.log(`开始监控 ${t} 的配置完成状态`),o(`正在等待 ${t} 配置完成...`),window.addEventListener("message",d,!1);const c=setInterval(()=>{try{if(a++,Date.now()-s>l)return void r(`${t} 配置超时，已超时 ${Math.floor(l/1e3)} 秒`);if(!e||e.closed)return void r(`${t} 的页面已关闭，继续处理下一个`);try{if(e.window&&!0===e.window._configAutoCompleted)return void r(`${t} 配置已完成`)}catch(t){try{e.postMessage({type:"CHECK_CONFIG_COMPLETED"},"*")}catch(e){}}if(a%5==0){const e=Math.floor((Date.now()-s)/1e3);console.log(`已等待 ${e} 秒，继续检查 ${t} 配置状态...`),o(`等待中... (${e}秒)`)}}catch(e){console.error(`监控 ${t} 配置状态时出错: ${e.message}`)}},i);function r(e){clearInterval(c),window.removeEventListener("message",d),console.log(e),o(e),n()}function d(e){try{e.data&&"CONFIG_COMPLETED"===e.data.type&&r(`${t} 配置已完成`)}catch(e){console.error("处理消息时出错:",e)}}setTimeout(()=>{o("提示: 如需手动继续，请在控制台执行: window.nextArticle()")},1e4),window.nextArticle=function(){r(`${t} 手动触发继续`)}})}(d,a.title),await l(s+1)}catch(e){console.error(`为素材 ${a.title} 生成推送链接时出错: ${e.message}`),o(`推送 ${a.title} 失败: ${e.message}`),await l(s+1)}}(0):n("没有选择素材进行推送")},()=>{console.log("已取消推送精选操作"),n("推送精选操作已取消")})}async function u(){const e=document.querySelector("#deleteNonOriginalButton");e&&(e.disabled=!0,e.textContent="收集非原创文章中...");const t=await async function(){const e=await $(500);if(console.log("共发现文章数：",e.length),console.log("文章列表：",e),0===e.length)return console.log("未发现文章"),[];const t=[];for(const n of e)1===n.is_non_original&&t.push({app_id:n.app_id,title:n.title});return t}();if(0===t.length)return console.log("未发现非原创文章"),void(e&&(e.textContent="删除非原创",e.disabled=!1));if(!confirm(`确定要删除 ${t.length} 篇非原创文章吗？此操作不可恢复！`))return console.log("已取消删除操作"),void(e&&(e.textContent="删除非原创",e.disabled=!1));let n=0;const o=window.location.href,i=c(o,"token");for(const l of t)try{await m(l.app_id,i,o),n++,e&&(e.textContent=`删除非原创 (${n}/${t.length})`)}catch(e){console.error(`删除失败: ${e.message}`)}setTimeout(()=>{location.reload()},1e3)}async function m(e,t,n){try{const n=`AppMsgId=${e}&token=${t}&lang=zh_CN&f=json&ajax=1`,o=await fetch("https://mp.weixin.qq.com/cgi-bin/operate_appmsg?sub=del&t=ajax-response",{body:n,method:"POST"}),i=await o.json();return console.log(`处理 ID: ${e} 的结果：`),console.log(i),i}catch(t){throw console.error(`处理 ID: ${e} 时发生错误：`),console.error(t),t}}async function f(e,t=null){try{const n=d(e),c=t?d(t):null;o(`开始上传视频: ${n.name}`),o(`文件大小: ${(n.size/1048576).toFixed(2)} MB`);const r=function(e){let t=document.getElementById("chrome-upload-iframe-window");t&&t.remove();t=document.createElement("div"),t.id="chrome-upload-iframe-window",t.style.position="fixed",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.zIndex="10000",t.style.width="80%",t.style.height="80%",t.style.backgroundColor="white",t.style.border="2px solid #4CAF50",t.style.borderRadius="10px",t.style.boxShadow="0 8px 24px rgba(0, 0, 0, 0.5)",t.style.overflow="hidden";const n=document.createElement("div");n.style.backgroundColor="#4CAF50",n.style.color="white",n.style.padding="10px 15px",n.style.fontWeight="bold",n.style.display="flex",n.style.justifyContent="space-between",n.style.alignItems="center",n.textContent=`正在上传: ${e.name}`;const i=document.createElement("button");i.style.backgroundColor="transparent",i.style.color="white",i.style.border="none",i.style.fontSize="20px",i.style.cursor="pointer",i.style.padding="0",i.style.width="30px",i.style.height="30px",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.textContent="×",i.addEventListener("click",()=>{t.remove()}),n.appendChild(i);const l=document.createElement("div");l.style.width="100%",l.style.height="calc(100% - 40px)";const s=document.createElement("iframe");function a(){let e=new URLSearchParams(window.location.search).get("token");if(!e){const t=window.location.href.match(/token=([^&]+)/);t&&t[1]&&(e=t[1])}return e}s.id="chrome-upload-iframe",s.style.width="100%",s.style.height="100%",s.style.border="none",s.style.background="#f5f5f5";const c=a();c?(s.src=`https://mp.weixin.qq.com/cgi-bin/appmsg?t=media/videomsg_edit&action=video_edit&type=15&isNew=1&token=${c}&lang=zh_CN`,o("已从当前页面提取token并设置上传地址")):(s.src="https://mp.weixin.qq.com/cgi-bin/appmsgvideo?action=upload_video",o("无法从当前页面提取token，使用默认上传地址"));return l.appendChild(s),t.appendChild(n),t.appendChild(l),document.body.appendChild(t),s}(n);o("等待iframe加载完成..."),await new Promise(e=>{r.onload=e,setTimeout(e,1e4)});let p=null;try{if(p=r.contentDocument||r.contentWindow.document,!p)return o("无法访问iframe的document对象，可能存在跨域问题"),g(r,n,c),!0}catch(e){return o(`访问iframe时出错: ${e.message}，尝试使用脚本注入方式`),g(r,n,c),!0}if(p){const d=['input[type="file"][accept*="video"]'];let u=null;for(const e of d)if(u=p.querySelector(e),u){o(`在iframe中找到文件输入框: ${e}`);break}if(u){o("准备设置文件到iframe中的输入框...");const d=new DataTransfer;d.items.add(e);try{u.files=d.files,u.dispatchEvent(new Event("change",{bubbles:!0})),o("文件已设置到iframe中的输入框，等待上传...");const e=l("label.weui-desktop-form__check-label.weui-desktop-form__tool__tips.video-setting__footer-link",p);e&&a(e,"上传协议");const c=l('input[type="checkbox"][class="weui-desktop-switch__input"]',p);if(c){a(c,"原创开关");const e=l("div.weui-desktop-dialog_original-video > div.weui-desktop-dialog__wrp > div.weui-desktop-dialog > div.weui-desktop-dialog__ft > div.weui-desktop-btn_wrp > button.weui-desktop-btn_primary",p);e&&a(e,"确认原创")}o("等待上传完成...（最多等待1分钟）");const r=6e4,m=1e3,f=Date.now(),g=[".tips_global"];await i(m);let h=!1,w=!1;for(;Date.now()-f<r;){for(const e of g){const t=l(e,p);if(t&&"none"!==window.getComputedStyle(t).display){o("检测到上传成功标识"),h=!0;break}}const e=s([".cover__options__item:nth-child(1)"],p);if(e&&!w&&(o("尝试设置封面..."),t)){o(`准备使用提供的封面文件: ${t.name}`),a(e,"封面编辑按钮"),o("尝试打开素材库...");const n=s([".weui-desktop-uploader__info-area__btn",".weui-desktop-btn.weui-desktop-btn_default"],p);if(n){a(n,"素材库按钮"),o("尝试上传本地素材...");const e=s(['.weui-desktop-upload_global-media input[type="file"][accept*="image"]'],p);if(e){const n=new DataTransfer;n.items.add(t),e.files=n.files,e.dispatchEvent(new Event("change",{bubbles:!0})),o(`已自动设置封面文件: ${t.name}`),o("等待封面文件上传完成..."),await i(3e3),o("尝试点击“下一步”按钮...");const l=[".weui-desktop-dialog_img-picker-with-crop .weui-desktop-dialog .weui-desktop-dialog__ft .weui-desktop-btn_wrp .weui-desktop-btn_primary"];let c=s(l,p);for(;!c||c.classList.contains("weui-desktop-btn_disabled");){if(await i(1e3),c=s(l,p),!c){o("未找到“下一步”按钮");break}c.classList.contains("weui-desktop-btn_disabled")&&o("封面上传中，“下一步”按钮尚不可点击")}o("封面上传完成，点击“下一步”按钮"),a(c,"下一步按钮"),o("等待封面截取完成..."),o("尝试确认封面设计...");if(confirmCoverBtn=s(['div.weui-desktop-dialog__wrp.weui-desktop-dialog_img-picker.weui-desktop-dialog_img-picker-with-crop:not([style*="display: none"]) > div > div.weui-desktop-dialog__ft > div:nth-child(3) > button'],p),confirmCoverBtn){for(;confirmCoverBtn.checkVisibility()||!w;)await i(1e3),a(confirmCoverBtn,"确认封面设计按钮"),confirmCoverBtn.checkVisibility()||(o("确认封面设计按钮已不可见"),w=!0),o("确认封面设计按钮尚不可点击");o("已确认封面设计"),w=!0}else o("未找到确认封面设计按钮")}else o("未找到上传本地素材的输入框")}else o("未找到素材库按钮")}if(p.body.textContent.includes("创建文件失败"))return o("检测到错误：创建文件失败 (200002)"),o("这通常是由于路径问题或权限不足导致的"),o("尝试解决方案：1. 确保文件路径没有特殊字符 2. 使用英文路径 3. 检查文件权限"),!1;if(h&&w)break;await i(m),o("仍在等待上传完成...")}if(!h)return o("上传超时"),!1;o("尝试点击“保存并发送”按钮...");const y=s([".video-setting__footer-btns-group .video-save-send-btn .weui-desktop-btn_default"],p);if(y){for(window.addEventListener("beforeunload",e=>{e.preventDefault()}),a(y,"“保存并发送”按钮");y.checkVisibility();)await i(1e3),a(y,"“保存并发送”按钮"),o("“保存并发送”按钮尚不可点击");o("发送配置页面加载完成")}o(`视频 ${n.name} 上传完成！`)}catch(e){o(`设置文件时出错: ${e.message}`),g(r,n,c)}}else o("在iframe中找不到文件输入框，尝试使用脚本注入"),g(r,n,c)}o(`视频 ${n.name} 上传处理完成！`);const u=document.getElementById("chrome-upload-iframe-window");return u&&u.remove(),!0}catch(e){return console.error("上传视频时出错:",e),o(`上传出错: ${e.message}`),!1}}function g(e,t,n=null){o("向iframe注入上传脚本...");const i=`\n        console.log('微信公众号视频上传脚本已注入iframe');\n        \n        // 注入的脚本将在iframe中执行\n        (async function() {\n            // 显示上传状态信息\n            function showUploadStatus(message) {\n                console.log('[iframe上传状态]', message);\n                // 这里可以添加自定义的状态显示逻辑\n            }\n            \n            showUploadStatus('开始上传视频: ${t.name.replace(/'/g,"\\'")}');\n            ${n?`showUploadStatus('封面文件: ${n.name.replace(/'/g,"\\'")}');`:""}\n            \n            // 查找文件输入框\n            const fileInput = document.querySelector('input[type="file"][accept*="video"]');\n            \n            if (fileInput) {\n                showUploadStatus('找到文件输入框');\n                \n                // 创建一个新的input元素，用于触发文件选择对话框\n                const hiddenInput = document.createElement('input');\n                hiddenInput.type = 'file';\n                hiddenInput.accept = 'video/*';\n                hiddenInput.style.display = 'none';\n                document.body.appendChild(hiddenInput);\n                \n                // 提示用户在iframe中选择文件\n                showUploadStatus('请在弹出的上传窗口中选择文件: ${t.name.replace(/'/g,"\\'")}');\n                ${n?`showUploadStatus('封面上传提示: 视频上传成功后，请手动上传封面文件: ${n.name.replace(/'/g,"\\'")}');`:""}\n                \n                // 这里无法直接设置文件到iframe中，需要用户手动选择\n                // 在实际使用中，可以考虑使用其他方式传递文件数据\n            } else {\n                showUploadStatus('找不到文件输入框');\n            }\n            \n            // 这里可以根据实际需求添加更多的自动化操作逻辑\n        })();\n    `;try{const t=e.contentDocument.createElement("script");t.textContent=i,e.contentDocument.body.appendChild(t),o("上传脚本已成功注入iframe")}catch(i){o(`注入脚本时出错: ${i.message}`);try{e.contentWindow.postMessage({type:"UPLOAD_VIDEO",fileName:t.name,fileSize:t.size,hasCover:!!n,coverFileName:n?n.name:null},"*"),o("已发送上传消息到iframe")}catch(e){o(`发送消息时出错: ${e.message}`)}}}async function h(e){if(!e||0===e.length)return void o("没有选择视频文件");o(`开始批量上传 ${e.length} 个视频文件`);let t=0,n=0;for(let i=0;i<e.length;i++){const l=e[i],s=l.video||l,a=l.cover||null;o(`\n--- 正在处理第 ${i+1}/${e.length} 个视频 ---`),o(`视频: ${s.name}`),a&&o(`封面: ${a.name}`);await f(s,a)?t++:(n++,o(`视频 ${s.name} 上传失败`))}o("\n=== 批量上传完成 ==="),o(`成功: ${t} 个，失败: ${n} 个`),x()&&(o("成功上传视频后，请刷新页面查看..."),location.reload())}function w(){if(!x())return console.log("当前页面不是视频列表页，脚本将不会初始化"),void n("请在微信公众号的视频列表页运行此脚本");if(document.getElementById("chrome-video-uploader-container"))return void console.log("悬浮按钮已存在，无需重复创建");const e=document.createElement("div");e.id="chrome-video-uploader-container",e.style.display="inline";const t=document.createElement("div");t.id="chrome-debug-info",t.style.marginBottom="10px",t.style.padding="10px",t.style.backgroundColor="#f5f5f5",t.style.borderRadius="4px",t.style.minHeight="60px",t.style.fontSize="12px",t.style.textAlign="left",t.style.whiteSpace="pre-wrap",t.style.fontFamily="monospace",t.textContent="调试信息：等待选择视频文件或目录...";const i=document.createElement("button");i.id="chrome-select-files-btn",i.classList.add("weui-desktop-btn","weui-desktop-btn_primary"),i.style.backgroundColor="#4CAF50",i.style.marginLeft="10px",i.textContent="上传多文件";const l=document.createElement("button");l.id="chrome-select-dir-btn",l.classList.add("weui-desktop-btn","weui-desktop-btn_primary"),l.style.backgroundColor="#2196F3",l.style.marginLeft="10px",l.textContent="上传目录";const s=document.createElement("input");s.type="file",s.id="chrome-file-selector",s.accept="video/*,image/png",s.multiple=!0,s.style.display="none";const a=document.createElement("input");a.type="file",a.id="chrome-dir-selector",a.webkitdirectory=!0,a.style.display="none";const r=document.createElement("button");r.classList.add("weui-desktop-btn","weui-desktop-btn_primary"),r.style.backgroundColor="#2196F3",r.style.marginLeft="10px",r.textContent="删除本页",r.id="deleteDirButton",r.setAttribute("data-action","delete-videos");const f=document.createElement("button");f.classList.add("weui-desktop-btn","weui-desktop-btn_primary"),f.style.backgroundColor="#2196F3",f.style.marginLeft="10px",f.textContent="删除非原创",f.id="deleteNonOriginalButton",f.setAttribute("data-action","delete-non-original-videos");const g=document.createElement("button");if(g.classList.add("weui-desktop-btn","weui-desktop-btn_primary"),g.style.backgroundColor="#4CAF50",g.style.marginLeft="10px",g.textContent="推送精选",g.id="pushFeaturedButton",g.setAttribute("data-action","push-featured-videos"),e.appendChild(i),e.appendChild(l),e.appendChild(s),e.appendChild(a),e.appendChild(r),e.appendChild(f),e.appendChild(g),(new Date).getTime()<new Date("2025-12-04").getTime()){const t=document.querySelector("#app > div.weui-desktop-block > div.weui-desktop-block__main > div > div:nth-child(1) > div.weui-desktop-panel__hd.weui-desktop-global-mod > div.weui-desktop-global__extra > div.weui-desktop-btn_wrp");t?t.parentNode.insertBefore(e,t.nextSibling):(console.error("目标元素未找到"),document.body.appendChild(e))}i.addEventListener("click",()=>{console.log("点击选择文件按钮"),n("按钮被点击，触发文件选择器..."),s.click()}),l.addEventListener("click",()=>{console.log("点击选择目录按钮"),n("按钮被点击，触发目录选择器..."),a.click()}),s.addEventListener("change",async()=>{console.log("文件选择发生变化");const e=Array.from(s.files);if(e.length>0){n(`已选择 ${e.length} 个文件\n`),e.slice(0,3).forEach((e,t)=>{o(`文件 ${t+1}: ${e.name}`),o(`大小: ${(e.size/1048576).toFixed(2)} MB`),o(`类型: ${e.type||"未知"}`)}),e.length>3&&o(`... 还有 ${e.length-3} 个文件`);let t=[];const i=new Map;e.forEach(e=>{if(e.name.toLowerCase().endsWith(".png")){const t=d(e),n=t.name.replace(/\.png$/i,"");i.set(n.toLowerCase(),t),o(`找到封面图片: ${t.name}`)}}),e.forEach(e=>{if(e.type.startsWith("video/")){const n=d(e),l=n.name.replace(/\.[^/.]+$/,""),s=i.get(l.toLowerCase());s?(o(`视频 ${n.name} 匹配到封面图片: ${s.name}`),t.push({video:n,cover:s})):(o(`视频 ${n.name} 没有找到匹配的封面图片`),t.push({video:n,cover:null}))}});const l=await b();o(`历史视频素材记录收集完成，共 ${l.length} 条`);const s=new Set(l.map(e=>y(e.title))),a=[],c=[];for(const e of t){const t=y(e.video.name);if(s.has(t)){const n=l.find(e=>y(e.title)===t);a.push({file:e.video.name,title:n&&n.title||"",time:n&&n.publish_time||""})}else c.push(e)}if(a.length>0){o(`检测到历史重复 ${a.length} 项`);const e=a.slice(0,10).map(e=>`${e.file} ≈ ${e.title}`).join("\n");confirm(`检测到 ${a.length} 个可能重复的视频：\n${e}\n选择“确定”跳过重复，或“取消”继续上传。`)?(t=c,o(`已跳过重复，剩余 ${t.length} 个待上传`)):o("用户选择继续上传包含重复的视频")}else o("未检测到历史重复视频");if(0===t.length)return o("未找到有效的视频文件"),void alert("请选择有效的视频文件");o(`\n筛选出 ${t.length} 个视频文件，准备上传`),await h(t)}else n("未选择任何文件")}),a.addEventListener("change",async()=>{console.log("目录选择发生变化");const e=Array.from(a.files);if(e.length>0){n(`已选择目录中的 ${e.length} 个文件\n`),e.slice(0,3).forEach((e,t)=>{o(`文件 ${t+1}: ${e.name}`),o(`大小: ${(e.size/1048576).toFixed(2)} MB`),o(`类型: ${e.type||"未知"}`)}),e.length>3&&o(`... 还有 ${e.length-3} 个文件`);let t=[];const i=new Map;e.forEach(e=>{if(e.name.toLowerCase().endsWith(".png")||e.name.toLowerCase().endsWith(".jpg")){const t=d(e),n=v(t);i.set(n.toLowerCase(),t),o(`找到封面图片: ${t.name}`)}}),e.forEach(e=>{if(e.type.startsWith("video/")){const n=d(e),l=v(n),s=i.get(l.toLowerCase());s?(o(`视频 ${n.name} 匹配到封面图片: ${s.name}`),t.push({video:n,cover:s})):(o(`视频 ${n.name} 没有找到匹配的封面图片`),t.push({video:n,cover:null}))}});const l=await b();o(`历史视频素材记录收集完成，共 ${l.length} 条`);const s=new Set(l.map(e=>e.title));o("标题集："+Array.from(s).join(", "));const a=[],c=[];for(const e of t){const t=y(e.video.name);if(o(`根据视频标题 ${t} 检查视频 ${e.video.name} 是否重复...`),s.has(t)){const n=l.find(e=>e.title===t);a.push({file:e.video.name,title:n&&n.title||"",time:n&&n.publish_time||""})}else c.push(e)}if(a.length>0){o(`检测到历史重复 ${a.length} 项`);const e=a.slice(0,10).map(e=>`${e.file} ≈ ${e.title}`).join("\n");confirm(`检测到 ${a.length} 个可能重复的视频：\n${e}\n选择“确定”跳过重复，或“取消”继续上传。`)?(t=c,o(`已跳过重复，剩余 ${t.length} 个待上传`)):o("用户选择继续上传包含重复的视频")}else o("未检测到历史重复视频");if(0===t.length)return o("所选目录中未找到有效的视频文件"),void alert("所选目录中未找到有效的视频文件");o(`\n筛选出 ${t.length} 个视频文件，准备上传`),await h(t)}else n("未选择任何目录或文件")}),r.addEventListener("click",()=>{console.log("点击删除本页视频按钮"),n("按钮被点击，删除本页视频..."),async function(){try{const e=document.querySelector("#deleteDirButton"),t=e?e.textContent:"删除本页视频",n=window.location.href;console.log(`使用当前页面URL作为Referer: ${n}`);const o=c(n,"token");if(!o)return console.error("无法从当前页面URL中提取token，请确保在包含token参数的页面上运行此代码"),void(e&&(e.textContent=t));if(console.log(`从当前页面提取到token: ${o}`),!(wx&&wx.cgiData&&wx.cgiData.item&&Array.isArray(wx.cgiData.item)))return console.error("未找到有效的wx.cgiData.item数据"),void(e&&(e.textContent=t));const i=wx.cgiData.item.filter(e=>e&&e.app_id).map(e=>({appId:e.app_id,title:e.title||"未知标题"}));if(0===i.length)return console.log("没有找到可处理的文章数据"),void(e&&(e.textContent=t));const l=i.length;let s;if(e&&(e.textContent=`删除本页视频 (0/${l})`),console.log(`共发现 ${l} 篇文章待处理：`),i.forEach((e,t)=>{console.log(`${t+1}. ID: ${e.appId}，标题: ${e.title}`)}),1===i.length)s=confirm(`是否删除这篇文章？\nID: ${i[0].appId}\n标题: ${i[0].title}`)?"1":"0";else{const e=`共发现 ${i.length} 篇文章，选择处理方式：\n0 - 取消操作\n1 - 逐个确认删除\n2 - 全部删除`;s=prompt(e,"0")}let a=0;switch(s){case"0":return console.log("已取消所有操作"),void(e&&(e.textContent=t));case"1":console.log("开始逐个确认删除...");for(const t of i)if(confirm(`是否删除这篇文章？\nID: ${t.appId}\n标题: ${t.title}`)){try{await m(t.appId,o),a++,e&&(e.textContent=`删除本页视频 (${a}/${l})`)}catch(e){console.error(`删除失败: ${e.message}`)}await new Promise(e=>setTimeout(e,1e3))}else console.log(`已跳过 ID: ${t.appId} 的文章`);console.log("逐个处理完成");break;case"2":if(!confirm(`确定要删除全部 ${i.length} 篇文章吗？此操作不可恢复！`))return console.log("已取消全部删除操作"),void(e&&(e.textContent=t));console.log("开始批量删除所有文章...");for(const t of i){console.log(`正在删除 ID: ${t.appId}`);try{await m(t.appId,o),a++,e&&(e.textContent=`删除本页视频 (${a}/${l})`)}catch(e){console.error(`删除失败: ${e.message}`)}}console.log(`全部 ${i.length} 篇文章删除操作已执行完成`);break;default:return console.log("无效输入，已取消操作"),void(e&&(e.textContent=t))}e&&(e.textContent=`删除完成 (${a}/${l})`,setTimeout(()=>{e.textContent=t},3e3)),setTimeout(()=>{location.reload()},1e3)}catch(e){console.error("批量处理过程中发生错误："),console.error(e);const t=document.querySelector("#deleteDirButton");t&&(t.textContent="删除本页视频")}}()}),f.addEventListener("click",()=>{console.log("点击删除非原创按钮"),n("按钮被点击，删除非原创..."),u()}),g.addEventListener("click",()=>{console.log("点击推送精选按钮"),n("按钮被点击，推送精选..."),p()}),console.log("Chrome调试工具视频上传悬浮按钮已成功创建"),n('悬浮按钮已创建完成，请点击"选择视频文件"按钮开始上传')}function y(e){if(!e)return"";let t=e.trim();return t=t.replace(/\.[^\/.]+$/,""),t.toLowerCase()}async function $(e=200){const t=c(window.location.href,"token")||null;if(!t)return o("无法获取token，历史记录抓取跳过"),[];const n=[];for(let i=0;i<e;i+=50){const l=`https://mp.weixin.qq.com/cgi-bin/appmsg?action=list_video&t=media/video_list&type=15&begin=${i}&count=50&token=${t}&lang=zh_CN&f=json&ajax=1`;try{const t=await fetch(l,{credentials:"include"}),s=await t.json(),a=s&&s.app_msg_info&&Array.isArray(s.app_msg_info.item)?s.app_msg_info.item:null;if(!a||0===a.length)break;o(`抓取历史记录第 ${i} 条开始，共 ${a.length} 条`);for(const e of a){const t=(e.title||e.appmsg_title||"").trim(),o=e.create_time||e.update_time||e.time||null,i=e.multi_item&&Array.isArray(e.multi_item)&&e.multi_item.length>0&&2===e.multi_item[0].video_ori_status?1:0,l=e.app_id||"";n.push({title:t,publish_time:o,is_non_original:i,app_id:l})}if(n.length>=e){o(`已抓取到 ${e} 条历史记录，停止抓取`);break}}catch(e){o(`抓取历史记录失败: ${e.message}`);break}}window.__wxVideoHistoryRecords=n;try{localStorage.setItem("wxVideoHistoryRecords",JSON.stringify({ts:Date.now(),records:n}))}catch{}return o(`历史视频素材记录收集完成，共 ${n.length} 条`),n}async function b(){return window.confirm("是否抓取历史视频素材发表记录？（最多200条）")?await $(200):(o("用户选择不抓取历史记录，跳过"),[])}function x(){const e=window.location.href,t=document.body.innerText.includes("视频列表")||document.body.innerText.includes("video list");return e.includes("mp.weixin.qq.com")&&(e.includes("video")||t)}function v(e){let t=e.name.replace(/\.[^/.]+$/,"");return t=t.replace(/[^\u4e00-\u9fa5]/g,""),t=t.replace(/[（）]/g,""),t}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",w):w(),window.ChromeVideoUploader={init:w,uploadVideo:f,batchUploadVideos:h,showDebugInfo:n,appendDebugInfo:o,normalizeFileName:r,createNormalizedFile:d},module.exports={}})();