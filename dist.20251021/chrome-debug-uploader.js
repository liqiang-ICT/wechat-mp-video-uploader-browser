(()=>{function e(e){const t=document.getElementById("chrome-debug-info");t?(t.textContent=e,t.style.display="block",console.log("[调试信息]",e)):console.log("[调试信息]",e)}function t(e){const t=document.getElementById("chrome-debug-info");t?(t.textContent+="\n"+e,console.log("[调试信息]",e)):console.log("[调试信息]",e)}function n(e){return new Promise(t=>setTimeout(t,e))}function o(e,t=document){const n=t.querySelector(e);return console.log(`查找元素: ${e}, 结果: ${n?"找到":"未找到"}`),n}function i(e,t=document){for(const n of e){const e=o(n,t);if(e)return console.log(`使用选择器成功找到元素: ${n}`),e}return console.warn(`尝试了 ${e.length} 种选择器都未能找到元素`),null}function l(e,t="元素"){if(!e)return console.error(`${t}不存在，无法点击`),!1;try{return e.click(),console.log(`成功点击 ${t}`),!0}catch(e){return console.error(`点击 ${t} 时出错:`,e),!1}}function s(e){const t=e.match(/^(.*)\((\d+)\)(\.[^.]+)?$/);if(t){const n=t[1].trim()+(t[3]||"");return console.log(`规范化文件名: ${e} -> ${n}`),n}return e}function a(e){const t=s(e.name);return t!==e.name?new File([e],t,{type:e.type,lastModified:e.lastModified}):e}async function c(e,t,n){try{const n=`AppMsgId=${e}&token=${t}&lang=zh_CN&f=json&ajax=1`,o=await fetch("https://mp.weixin.qq.com/cgi-bin/operate_appmsg?sub=del&t=ajax-response",{body:n,method:"POST"}),i=await o.json();return console.log(`处理 ID: ${e} 的结果：`),console.log(i),i}catch(t){throw console.error(`处理 ID: ${e} 时发生错误：`),console.error(t),t}}async function r(e,s=null){try{const c=a(e),r=s?a(s):null;t(`开始上传视频: ${c.name}`),t(`文件大小: ${(c.size/1048576).toFixed(2)} MB`);const p=function(e){let n=document.getElementById("chrome-upload-iframe-window");n&&n.remove();n=document.createElement("div"),n.id="chrome-upload-iframe-window",n.style.position="fixed",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.zIndex="10000",n.style.width="80%",n.style.height="80%",n.style.backgroundColor="white",n.style.border="2px solid #4CAF50",n.style.borderRadius="10px",n.style.boxShadow="0 8px 24px rgba(0, 0, 0, 0.5)",n.style.overflow="hidden";const o=document.createElement("div");o.style.backgroundColor="#4CAF50",o.style.color="white",o.style.padding="10px 15px",o.style.fontWeight="bold",o.style.display="flex",o.style.justifyContent="space-between",o.style.alignItems="center",o.textContent=`正在上传: ${e.name}`;const i=document.createElement("button");i.style.backgroundColor="transparent",i.style.color="white",i.style.border="none",i.style.fontSize="20px",i.style.cursor="pointer",i.style.padding="0",i.style.width="30px",i.style.height="30px",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.textContent="×",i.addEventListener("click",()=>{n.remove()}),o.appendChild(i);const l=document.createElement("div");l.style.width="100%",l.style.height="calc(100% - 40px)";const s=document.createElement("iframe");function a(){let e=new URLSearchParams(window.location.search).get("token");if(!e){const t=window.location.href.match(/token=([^&]+)/);t&&t[1]&&(e=t[1])}return e}s.id="chrome-upload-iframe",s.style.width="100%",s.style.height="100%",s.style.border="none",s.style.background="#f5f5f5";const c=a();c?(s.src=`https://mp.weixin.qq.com/cgi-bin/appmsg?t=media/videomsg_edit&action=video_edit&type=15&isNew=1&token=${c}&lang=zh_CN`,t("已从当前页面提取token并设置上传地址")):(s.src="https://mp.weixin.qq.com/cgi-bin/appmsgvideo?action=upload_video",t("无法从当前页面提取token，使用默认上传地址"));return l.appendChild(s),n.appendChild(o),n.appendChild(l),document.body.appendChild(n),s}(c);t("等待iframe加载完成..."),await new Promise(e=>{p.onload=e,setTimeout(e,1e4)});let u=null;try{if(u=p.contentDocument||p.contentWindow.document,!u)return t("无法访问iframe的document对象，可能存在跨域问题"),d(p,c,r),!0}catch(e){return t(`访问iframe时出错: ${e.message}，尝试使用脚本注入方式`),d(p,c,r),!0}if(u){const a=['input[type="file"][accept*="video"]'];let m=null;for(const e of a)if(m=u.querySelector(e),m){t(`在iframe中找到文件输入框: ${e}`);break}if(m){t("准备设置文件到iframe中的输入框...");const a=new DataTransfer;a.items.add(e);try{m.files=a.files,m.dispatchEvent(new Event("change",{bubbles:!0})),t("文件已设置到iframe中的输入框，等待上传...");const e=o("label.weui-desktop-form__check-label.weui-desktop-form__tool__tips.video-setting__footer-link",u);e&&l(e,"上传协议");const r=o('input[type="checkbox"][class="weui-desktop-switch__input"]',u);if(r){l(r,"原创开关");const e=o("div.weui-desktop-dialog_original-video > div.weui-desktop-dialog__wrp > div.weui-desktop-dialog > div.weui-desktop-dialog__ft > div.weui-desktop-btn_wrp > button.weui-desktop-btn_primary",u);e&&l(e,"确认原创")}t("等待上传完成...（最多等待1分钟）");const d=6e4,p=1e3,f=Date.now(),g=[".tips_global"];await n(p);let h=!1,w=!1;for(;Date.now()-f<d;){for(const e of g){const n=o(e,u);if(n&&"none"!==window.getComputedStyle(n).display){t("检测到上传成功标识"),h=!0;break}}const e=i([".cover__options__item:nth-child(1)"],u);if(e&&!w&&(t("尝试设置封面..."),s)){t(`准备使用提供的封面文件: ${s.name}`),l(e,"封面编辑按钮"),t("尝试打开素材库...");const o=i([".weui-desktop-uploader__info-area__btn",".weui-desktop-btn.weui-desktop-btn_default"],u);if(o){l(o,"素材库按钮"),t("尝试上传本地素材...");const e=i(['.weui-desktop-upload_global-media input[type="file"][accept*="image"]'],u);if(e){const o=new DataTransfer;o.items.add(s),e.files=o.files,e.dispatchEvent(new Event("change",{bubbles:!0})),t(`已自动设置封面文件: ${s.name}`),t("等待封面文件上传完成..."),await n(3e3),t("尝试点击“下一步”按钮...");const a=[".weui-desktop-dialog_img-picker-with-crop .weui-desktop-dialog .weui-desktop-dialog__ft .weui-desktop-btn_wrp .weui-desktop-btn_primary"];let c=i(a,u);for(;!c||c.classList.contains("weui-desktop-btn_disabled");){if(await n(1e3),c=i(a,u),!c){t("未找到“下一步”按钮");break}c.classList.contains("weui-desktop-btn_disabled")&&t("封面上传中，“下一步”按钮尚不可点击")}t("封面上传完成，点击“下一步”按钮"),l(c,"下一步按钮"),t("等待封面截取完成..."),t("尝试确认封面设计...");if(confirmCoverBtn=i(['div.weui-desktop-dialog__wrp.weui-desktop-dialog_img-picker.weui-desktop-dialog_img-picker-with-crop:not([style*="display: none"]) > div > div.weui-desktop-dialog__ft > div:nth-child(3) > button'],u),confirmCoverBtn){for(;confirmCoverBtn.checkVisibility()||!w;)await n(1e3),l(confirmCoverBtn,"确认封面设计按钮"),confirmCoverBtn.checkVisibility()||(t("确认封面设计按钮已不可见"),w=!0),t("确认封面设计按钮尚不可点击");t("已确认封面设计"),w=!0}else t("未找到确认封面设计按钮")}else t("未找到上传本地素材的输入框")}else t("未找到素材库按钮")}if(u.body.textContent.includes("创建文件失败"))return t("检测到错误：创建文件失败 (200002)"),t("这通常是由于路径问题或权限不足导致的"),t("尝试解决方案：1. 确保文件路径没有特殊字符 2. 使用英文路径 3. 检查文件权限"),!1;if(h&&w)break;await n(p),t("仍在等待上传完成...")}if(!h)return t("上传超时"),!1;t("尝试点击“保存并发送”按钮...");const y=i([".video-setting__footer-btns-group .video-save-send-btn .weui-desktop-btn_default"],u);if(y){for(window.addEventListener("beforeunload",e=>{e.preventDefault()}),l(y,"“保存并发送”按钮");y.checkVisibility();)await n(1e3),l(y,"“保存并发送”按钮"),t("“保存并发送”按钮尚不可点击");t("发送配置页面加载完成")}t(`视频 ${c.name} 上传完成！`)}catch(e){t(`设置文件时出错: ${e.message}`),d(p,c,r)}}else t("在iframe中找不到文件输入框，尝试使用脚本注入"),d(p,c,r)}t(`视频 ${c.name} 上传处理完成！`);const m=document.getElementById("chrome-upload-iframe-window");return m&&m.remove(),!0}catch(e){return console.error("上传视频时出错:",e),t(`上传出错: ${e.message}`),!1}}function d(e,n,o=null){t("向iframe注入上传脚本...");const i=`\n        console.log('微信公众号视频上传脚本已注入iframe');\n        \n        // 注入的脚本将在iframe中执行\n        (async function() {\n            // 显示上传状态信息\n            function showUploadStatus(message) {\n                console.log('[iframe上传状态]', message);\n                // 这里可以添加自定义的状态显示逻辑\n            }\n            \n            showUploadStatus('开始上传视频: ${n.name.replace(/'/g,"\\'")}');\n            ${o?`showUploadStatus('封面文件: ${o.name.replace(/'/g,"\\'")}');`:""}\n            \n            // 查找文件输入框\n            const fileInput = document.querySelector('input[type="file"][accept*="video"]');\n            \n            if (fileInput) {\n                showUploadStatus('找到文件输入框');\n                \n                // 创建一个新的input元素，用于触发文件选择对话框\n                const hiddenInput = document.createElement('input');\n                hiddenInput.type = 'file';\n                hiddenInput.accept = 'video/*';\n                hiddenInput.style.display = 'none';\n                document.body.appendChild(hiddenInput);\n                \n                // 提示用户在iframe中选择文件\n                showUploadStatus('请在弹出的上传窗口中选择文件: ${n.name.replace(/'/g,"\\'")}');\n                ${o?`showUploadStatus('封面上传提示: 视频上传成功后，请手动上传封面文件: ${o.name.replace(/'/g,"\\'")}');`:""}\n                \n                // 这里无法直接设置文件到iframe中，需要用户手动选择\n                // 在实际使用中，可以考虑使用其他方式传递文件数据\n            } else {\n                showUploadStatus('找不到文件输入框');\n            }\n            \n            // 这里可以根据实际需求添加更多的自动化操作逻辑\n        })();\n    `;try{const n=e.contentDocument.createElement("script");n.textContent=i,e.contentDocument.body.appendChild(n),t("上传脚本已成功注入iframe")}catch(i){t(`注入脚本时出错: ${i.message}`);try{e.contentWindow.postMessage({type:"UPLOAD_VIDEO",fileName:n.name,fileSize:n.size,hasCover:!!o,coverFileName:o?o.name:null},"*"),t("已发送上传消息到iframe")}catch(e){t(`发送消息时出错: ${e.message}`)}}}async function p(e){if(!e||0===e.length)return void t("没有选择视频文件");t(`开始批量上传 ${e.length} 个视频文件`);let n=0,o=0;for(let i=0;i<e.length;i++){const l=e[i],s=l.video||l,a=l.cover||null;t(`\n--- 正在处理第 ${i+1}/${e.length} 个视频 ---`),t(`视频: ${s.name}`),a&&t(`封面: ${a.name}`);await r(s,a)?n++:(o++,t(`视频 ${s.name} 上传失败`))}t("\n=== 批量上传完成 ==="),t(`成功: ${n} 个，失败: ${o} 个`),u()&&(t("成功上传视频后，请刷新页面查看..."),location.reload())}function u(){const e=window.location.href,t=document.body.innerText.includes("视频列表")||document.body.innerText.includes("video list");return e.includes("mp.weixin.qq.com")&&(e.includes("video")||t)}function m(e){let t=e.name.replace(/\.[^/.]+$/,"");return t=t.replace(/[^\u4e00-\u9fa5]/g,""),t=t.replace(/[（）]/g,""),t}function f(){if(!u())return console.log("当前页面不是视频列表页，脚本将不会初始化"),void e("请在微信公众号的视频列表页运行此脚本");if(document.getElementById("chrome-video-uploader-container"))return void console.log("悬浮按钮已存在，无需重复创建");const n=document.createElement("div");n.id="chrome-video-uploader-container",n.style.display="inline";const o=document.createElement("div");o.id="chrome-debug-info",o.style.marginBottom="10px",o.style.padding="10px",o.style.backgroundColor="#f5f5f5",o.style.borderRadius="4px",o.style.minHeight="60px",o.style.fontSize="12px",o.style.textAlign="left",o.style.whiteSpace="pre-wrap",o.style.fontFamily="monospace",o.textContent="调试信息：等待选择视频文件或目录...";const i=document.createElement("button");i.id="chrome-select-files-btn",i.classList.add("weui-desktop-btn","weui-desktop-btn_primary"),i.style.backgroundColor="#4CAF50",i.style.marginLeft="10px",i.textContent="选择视频文件";const l=document.createElement("button");l.id="chrome-select-dir-btn",l.classList.add("weui-desktop-btn","weui-desktop-btn_primary"),l.style.backgroundColor="#2196F3",l.style.marginLeft="10px",l.textContent="选择视频目录";const s=document.createElement("input");s.type="file",s.id="chrome-file-selector",s.accept="video/*,image/png",s.multiple=!0,s.style.display="none";const r=document.createElement("input");r.type="file",r.id="chrome-dir-selector",r.webkitdirectory=!0,r.style.display="none";const d=document.createElement("button");if(d.id="chrome-delete-dir-btn",d.classList.add("weui-desktop-btn","weui-desktop-btn_primary"),d.style.backgroundColor="#2196F3",d.style.marginLeft="10px",d.textContent="删除本页视频",d.id="deleteDirButton",d.setAttribute("data-action","delete-videos"),n.appendChild(i),n.appendChild(l),n.appendChild(s),n.appendChild(r),n.appendChild(d),(new Date).getTime()<new Date("2025-11-04").getTime()){const e=document.querySelector("#app > div.weui-desktop-block > div.weui-desktop-block__main > div > div:nth-child(1) > div.weui-desktop-panel__hd.weui-desktop-global-mod > div.weui-desktop-global__extra > div.weui-desktop-btn_wrp");e?e.parentNode.insertBefore(n,e.nextSibling):(console.error("目标元素未找到"),document.body.appendChild(n))}i.addEventListener("click",()=>{console.log("点击选择文件按钮"),e("按钮被点击，触发文件选择器..."),s.click()}),l.addEventListener("click",()=>{console.log("点击选择目录按钮"),e("按钮被点击，触发目录选择器..."),r.click()}),s.addEventListener("change",async()=>{console.log("文件选择发生变化");const n=Array.from(s.files);if(n.length>0){e(`已选择 ${n.length} 个文件\n`),n.slice(0,3).forEach((e,n)=>{t(`文件 ${n+1}: ${e.name}`),t(`大小: ${(e.size/1048576).toFixed(2)} MB`),t(`类型: ${e.type||"未知"}`)}),n.length>3&&t(`... 还有 ${n.length-3} 个文件`);const o=[],i=new Map;if(n.forEach(e=>{if(e.name.toLowerCase().endsWith(".png")){const n=a(e),o=n.name.replace(/\.png$/i,"");i.set(o.toLowerCase(),n),t(`找到封面图片: ${n.name}`)}}),n.forEach(e=>{if(e.type.startsWith("video/")){const n=a(e),l=n.name.replace(/\.[^/.]+$/,""),s=i.get(l.toLowerCase());s?(t(`视频 ${n.name} 匹配到封面图片: ${s.name}`),o.push({video:n,cover:s})):(t(`视频 ${n.name} 没有找到匹配的封面图片`),o.push({video:n,cover:null}))}}),0===o.length)return t("未找到有效的视频文件"),void alert("请选择有效的视频文件");t(`\n筛选出 ${o.length} 个视频文件，准备上传`),await p(o)}else e("未选择任何文件")}),r.addEventListener("change",async()=>{console.log("目录选择发生变化");const n=Array.from(r.files);if(n.length>0){e(`已选择目录中的 ${n.length} 个文件\n`),n.slice(0,3).forEach((e,n)=>{t(`文件 ${n+1}: ${e.name}`),t(`大小: ${(e.size/1048576).toFixed(2)} MB`),t(`类型: ${e.type||"未知"}`)}),n.length>3&&t(`... 还有 ${n.length-3} 个文件`);const o=[],i=new Map;if(n.forEach(e=>{if(e.name.toLowerCase().endsWith(".png")||e.name.toLowerCase().endsWith(".jpg")){const n=a(e),o=m(n);i.set(o.toLowerCase(),n),t(`找到封面图片: ${n.name}`)}}),n.forEach(e=>{if(e.type.startsWith("video/")){const n=a(e),l=m(n),s=i.get(l.toLowerCase());s?(t(`视频 ${n.name} 匹配到封面图片: ${s.name}`),o.push({video:n,cover:s})):(t(`视频 ${n.name} 没有找到匹配的封面图片`),o.push({video:n,cover:null}))}}),0===o.length)return t("所选目录中未找到有效的视频文件"),void alert("所选目录中未找到有效的视频文件");t(`\n筛选出 ${o.length} 个视频文件，准备上传`),await p(o)}else e("未选择任何目录或文件")}),d.addEventListener("click",()=>{console.log("点击删除本页视频按钮"),e("按钮被点击，删除本页视频..."),async function(){try{const e=document.querySelector("#deleteDirButton"),t=e?e.textContent:"删除本页视频",n=window.location.href;console.log(`使用当前页面URL作为Referer: ${n}`);const o=function(e,t){if(!e||!t)return null;const n=e.split("?")[1];if(!n)return null;const o=n.split("&");for(const e of o){const[n,o]=e.split("=");if(n===t)return o}return null}(n,"token");if(!o)return console.error("无法从当前页面URL中提取token，请确保在包含token参数的页面上运行此代码"),void(e&&(e.textContent=t));if(console.log(`从当前页面提取到token: ${o}`),!(wx&&wx.cgiData&&wx.cgiData.item&&Array.isArray(wx.cgiData.item)))return console.error("未找到有效的wx.cgiData.item数据"),void(e&&(e.textContent=t));const i=wx.cgiData.item.filter(e=>e&&e.app_id).map(e=>({appId:e.app_id,title:e.title||"未知标题"}));if(0===i.length)return console.log("没有找到可处理的文章数据"),void(e&&(e.textContent=t));const l=i.length;let s;if(e&&(e.textContent=`删除本页视频 (0/${l})`),console.log(`共发现 ${l} 篇文章待处理：`),i.forEach((e,t)=>{console.log(`${t+1}. ID: ${e.appId}，标题: ${e.title}`)}),1===i.length)s=confirm(`是否删除这篇文章？\nID: ${i[0].appId}\n标题: ${i[0].title}`)?"1":"0";else{const e=`共发现 ${i.length} 篇文章，选择处理方式：\n0 - 取消操作\n1 - 逐个确认删除\n2 - 全部删除`;s=prompt(e,"0")}let a=0;switch(s){case"0":return console.log("已取消所有操作"),void(e&&(e.textContent=t));case"1":console.log("开始逐个确认删除...");for(const t of i)if(confirm(`是否删除这篇文章？\nID: ${t.appId}\n标题: ${t.title}`)){try{await c(t.appId,o),a++,e&&(e.textContent=`删除本页视频 (${a}/${l})`)}catch(e){console.error(`删除失败: ${e.message}`)}await new Promise(e=>setTimeout(e,1e3))}else console.log(`已跳过 ID: ${t.appId} 的文章`);console.log("逐个处理完成");break;case"2":if(!confirm(`确定要删除全部 ${i.length} 篇文章吗？此操作不可恢复！`))return console.log("已取消全部删除操作"),void(e&&(e.textContent=t));console.log("开始批量删除所有文章...");for(const t of i){console.log(`正在删除 ID: ${t.appId}`);try{await c(t.appId,o),a++,e&&(e.textContent=`删除本页视频 (${a}/${l})`)}catch(e){console.error(`删除失败: ${e.message}`)}}console.log(`全部 ${i.length} 篇文章删除操作已执行完成`);break;default:return console.log("无效输入，已取消操作"),void(e&&(e.textContent=t))}e&&(e.textContent=`删除完成 (${a}/${l})`,setTimeout(()=>{e.textContent=t},3e3)),setTimeout(()=>{location.reload()},1e3)}catch(e){console.error("批量处理过程中发生错误："),console.error(e);const t=document.querySelector("#deleteDirButton");t&&(t.textContent="删除本页视频")}}()}),console.log("Chrome调试工具视频上传悬浮按钮已成功创建"),e('悬浮按钮已创建完成，请点击"选择视频文件"按钮开始上传')}console.log("微信公众号视频上传调试工具(视频列表页版本)已加载"),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",f):f(),window.ChromeVideoUploader={init:f,uploadVideo:r,batchUploadVideos:p,showDebugInfo:e,appendDebugInfo:t,normalizeFileName:s,createNormalizedFile:a},module.exports={}})();