(()=>{if(!document.getElementById("js_auto_tag_add_btn")){const n=document.createElement("button");n.id="js_auto_tag_add_btn",n.textContent="自动批量标签",n.style.marginLeft="10px",n.style.padding="5px 10px",n.style.backgroundColor="#007bff",n.style.color="white",n.style.border="none",n.style.borderRadius="4px",n.style.cursor="pointer",document.getElementById("js_tag_add_btn").parentNode.insertBefore(n,document.getElementById("js_tag_add_btn").nextSibling),n.addEventListener("click",async function(){if(e("开始自动批量标签..."),document.getElementById("js_auto_tag_config_dialog"))document.getElementById("js_auto_tag_config_dialog").checkVisibility()||(document.getElementById("js_auto_tag_config_dialog").style.display="block");else{const n=document.createElement("div");n.id="js_auto_tag_config_dialog",n.style.position="fixed",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.backgroundColor="white",n.style.padding="20px",n.style.borderRadius="8px",n.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)",n.style.zIndex="9999",n.innerHTML='\n        <div style="display: flex; justify-content: space-between; align-items: center;">\n            <h3 style="margin: 0;">自动标签配置</h3>\n            <span style="cursor: pointer;" id="js_close_config_dialog">&times;</span>\n        </div>\n        <div style="margin-top: 20px;">\n            <label>选择标签：</label>\n            <div id="js_tag_list"></div>\n        </div>\n        <div style="margin-top: 20px;">\n            <label>页面范围：</label>\n            <input type="number" id="js_start_page" value="1" style="width: 50px;">\n            <label>-</label>\n            <input type="number" id="js_end_page" value="-1" style="width: 50px;">\n        </div>\n        <div style="margin-top: 20px;">\n            <label>间隔时间：</label>\n            <input type="number" id="js_interval_time" value="500" style="width: 50px;">\n            <label>毫秒</label>\n        </div>\n        <div style="margin-top: 20px;">\n            <button id="js_confirm_add_tags" class="btn btn_primary">开始</button>\n        </div>\n        <div style="margin-top: 20px;">\n            <span id="js_status_message" style="font-size: 12px; color: #666;">请选择要添加的标签，以及要处理的页面范围。</span>\n        </div>\n        ',document.body.appendChild(n);const i=Math.ceil(wx.cgiData.total_user_num/20);document.getElementById("js_end_page").value=i;const s=document.getElementById("js_tag_list");wx.cgiData&&wx.cgiData.group_list&&wx.cgiData.group_list.length>0?wx.cgiData.group_list.forEach(e=>{if(e.id>"0"){const t=document.createElement("div");t.style.display="inline-block",t.style.marginRight="10px",t.innerHTML=`<input type="checkbox" value="${e.id}"> ${e.name}`,s.appendChild(t)}}):e("获取到的标签清单为空"),document.getElementById("js_close_config_dialog").addEventListener("click",()=>{document.getElementById("js_status_message").textContent="请选择要添加的标签，以及要处理的页面范围。",n.style.display="none"}),document.getElementById("js_confirm_add_tags").addEventListener("click",async()=>{const n=document.querySelectorAll("#js_tag_list input:checked");if(0!==n.length){const i=parseInt(document.getElementById("js_start_page").value),s=parseInt(document.getElementById("js_end_page").value);if(isNaN(i)||isNaN(s)||i<1||s<1||i>s)return void(document.getElementById("js_status_message").textContent="请输入有效的起始页和结束页。");{t("开始处理...");const a=parseInt(document.getElementById("js_interval_time").value);if(isNaN(a))return void t("请输入有效的间隔时间（0ms表示不间隔）。");let o=1,l=wx.cgiData.user_list.map(e=>({user_openid:e.id,user_create_time:e.create_time,user_name:e.nick_name}));if(0===l.length)return void e("当前所在页没有用户");let d={action:"get_user_list",group_id:"-2",begin_openid:l[l.length-1].user_openid,begin_create_time:l[l.length-1].user_create_time,token:window.location.href.match(/token=(\d+)/)[1],offset:0,limit:20,backfoward:1,lang:"zh_CN",f:"json",ajax:1};for(;o<i-25;){t("跳转到页面："+o),d.offset=480;try{const e=await fetch("https://mp.weixin.qq.com/cgi-bin/user_tag?action=get_user_list&"+new URLSearchParams(d).toString(),{method:"GET"});if(!e.ok){t("获取用户列表失败："+e.statusText);continue}try{l=(await e.json()).user_list.user_info_list,d.begin_openid=l[l.length-1].user_openid,d.begin_create_time=l[l.length-1].user_create_time,o+=25}catch(e){t("解析用户列表失败："+e.message);continue}}catch(e){t("获取用户列表失败："+e.message);continue}}if(o!==i){e("跳转到开始页："+i),d.offset=20*(i-o-1),i<o&&(d.backfoward=0,d.offset=20*(o-i-1));const t=await fetch("https://mp.weixin.qq.com/cgi-bin/user_tag?action=get_user_list&"+new URLSearchParams(d).toString(),{method:"GET"});l=(await t.json()).user_list.user_info_list,o=i}if(0===l.length)return void e("当前所在页没有用户");d.backfoward=1;const c=Array.from(n).map(e=>e.value).join("|"),r=Array.from(n).map(e=>e.nextSibling.textContent.trim()).join(",");e("用户选择的标签："+r);for(let n=i;n<=s;n++){if(n!==o){d.offset=20*(n-o-1),d.begin_openid=l[l.length-1].user_openid,d.begin_create_time=l[l.length-1].user_create_time;const t=await fetch("https://mp.weixin.qq.com/cgi-bin/user_tag?action=get_user_list&"+new URLSearchParams(d).toString(),{method:"GET"}),i=await t.json();e("开始页用户列表："+JSON.stringify(i)),l=i.user_list.user_info_list,o=n}if(0===l.length){e("当前所在页没有用户");continue}const i={token:window.location.href.match(/token=(\d+)/)[1],lang:"zh_CN",f:"json",ajax:1,groupid_list:c,user_openid_list:l.map(e=>e.user_openid).join("|"),cexpandcol:3};console.log("批量标签接口参数：",i),t("正在处理第"+n+"页用户，标签："+r+"，用户："+l.map(e=>e.user_name).join(","));try{const n=await fetch("https://mp.weixin.qq.com/cgi-bin/user_tag?action=batch_set_tag",{method:"POST",body:new URLSearchParams(i)});if(!n.ok){t("批量打标签失败："+n.statusText);continue}try{e("处理结果："+(0===(await n.json()).base_resp.ret?"成功":"失败"))}catch(e){t("解析批量打标签结果失败："+e.message+"，重试");continue}}catch(e){t("批量打标签失败："+e.message);continue}a>0&&await new Promise(e=>setTimeout(e,a))}t("处理完成！")}}else document.getElementById("js_status_message").textContent="请选择要添加的标签。"})}})}function e(e){const t=document.getElementById("js_status_message");t?(t.textContent+="\n"+e,console.log("[调试信息]",e)):console.log("[调试信息]",e)}function t(e){const t=document.getElementById("js_status_message");t&&(t.textContent=e),console.log("[状态更新]",e)}module.exports={}})();